# Crypto Payment Integration Fix

## Problem Identified

The payment links generated by your code were not showing the crypto payment option because the Stripe checkout sessions were configured with only `payment_method_types: ['card']` instead of including the crypto payment method.

## Root Cause

In `src/modules/stripe/stripe.service.ts`, the `createCryptoPaymentLink` method and `createPayment` method were hardcoded to use only card payments:

```typescript
payment_method_types: ['card']; // This was the issue
```

## Changes Made

### 1. Updated Payment Method Types

**File:** `src/modules/stripe/stripe.service.ts`

**Before:**

```typescript
payment_method_types: ['card']; // Stripe crypto is limited, using card for demo
```

**After:**

```typescript
payment_method_types: ['crypto', 'card']; // Support both crypto and card payments
```

### 2. Enhanced createCryptoPaymentLink Method

Added support for:

- **Crypto-only payments** via `cryptoOnly` flag
- **Environment-based configuration** via `STRIPE_ENABLE_CARD_PAYMENTS`
- **Better logging** and error handling
- **Proper TypeScript types**

### 3. Updated Session Service Calls

**File:** `src/modules/session/session.service.ts`

Updated both `stopSession` and `recreatePaymentLink` methods to use the enhanced payment link creation with both crypto and card support.

## Key Requirements for Crypto Payments

### Stripe Account Requirements

1. âœ… **US-based Stripe account** (crypto payments only available for US businesses)
2. âœ… **Crypto payment method enabled** in Stripe Dashboard
3. âœ… **Active Stripe account** with crypto payments capability
4. âœ… **USD currency** (required for crypto payments)

### Code Requirements (Now Fixed)

1. âœ… **payment_method_types** includes 'crypto'
2. âœ… **Currency set to 'usd'**
3. âœ… **Proper Stripe API version**
4. âœ… **Valid line items configuration**

## Testing the Fix

### 1. Quick Test

Run the provided test script:

```bash
./test-crypto-payment.sh
```

### 2. Diagnostic Check

Run the diagnostic script to verify configuration:

```bash
./diagnose-crypto-payment.sh
```

### 3. Manual Testing

1. Use the payment URL generated by the test
2. Open it in your browser
3. You should now see **both options**:
   - ðŸ’³ **Card payment**
   - ðŸª™ **Pay with crypto**

## Environment Configuration

### Optional Environment Variables

Add to your `.env` file:

```bash
# Enable/disable card payments alongside crypto (default: true)
STRIPE_ENABLE_CARD_PAYMENTS=true

# Stripe URLs for crypto payments
STRIPE_SUCCESS_URL=https://your-domain.com/success?session_id={CHECKOUT_SESSION_ID}
STRIPE_CANCEL_URL=https://your-domain.com/cancel
```

## API Usage Examples

### Creating Crypto-Only Payment

```typescript
const session = await stripeService.createCryptoPaymentLink(
  sessionId,
  amountUsd,
  {
    cryptoOnly: true, // Only crypto payments
    expiresInMinutes: 60,
    metadata: { userId, source: 'api' },
  },
);
```

### Creating Flexible Payment (Crypto + Card)

```typescript
const session = await stripeService.createCryptoPaymentLink(
  sessionId,
  amountUsd,
  {
    cryptoOnly: false, // Both crypto and card
    expiresInMinutes: 1440, // 24 hours
    metadata: { userId, source: 'api' },
  },
);
```

## Troubleshooting

### If Crypto Option Still Doesn't Appear

1. **Check Stripe Dashboard**
   - Go to Settings > Payment methods
   - Verify "Crypto" is enabled and active
   - Status should be "Active", not "Pending"

2. **Verify Account Eligibility**
   - Must be US-based Stripe account
   - Contact Stripe support if crypto is not available

3. **Check Application Logs**
   - Look for Stripe API errors
   - Verify API key has correct permissions

4. **Test with Stripe's Test Mode**
   - Use test API keys
   - Test with small amounts ($1-5)

### Common Error Messages

**"Payment method not available"**

- Crypto not enabled in Stripe Dashboard
- Account not eligible for crypto payments

**"Invalid payment_method_types"**

- Using old Stripe API version
- TypeScript type mismatch (now fixed)

## What Customers Will See

### Before Fix

- Only card payment option
- No crypto payment choice

### After Fix

- **Card payment option** (traditional)
- **Pay with crypto option** (new)
- When selecting crypto:
  - Redirected to crypto.stripe.com
  - Can connect crypto wallet
  - Choose USDC, USDP, or other supported tokens
  - Select network (Ethereum, Polygon, Solana, Base)

## Supported Cryptocurrencies

According to Stripe documentation:

- **USDC** on Ethereum, Solana, Polygon, and Base
- **USDP** on Ethereum and Solana
- **USDG** on Ethereum

## Next Steps

1. **Test the payment flow** with the generated URLs
2. **Verify crypto option appears** in checkout
3. **Test small crypto payment** in test mode
4. **Monitor application logs** for any errors
5. **Consider adding webhook handling** for crypto payment events

## Files Modified

1. `src/modules/stripe/stripe.service.ts` - Main payment logic
2. `src/modules/session/session.service.ts` - Service integration
3. `test-crypto-payment.sh` - Testing script
4. `diagnose-crypto-payment.sh` - Diagnostic tool

The integration should now properly display the crypto payment option alongside card payments when you generate payment links through your API.
